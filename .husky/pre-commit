#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook that matches CI checks
# Ensures local development catches the same issues as CI

echo "üîç Running pre-commit checks..."

# Track if any check failed
FAILED=0

# 1. ESLint
echo "\nüìã Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "‚ùå ESLint failed!"
  FAILED=1
fi

# 2. Prettier
echo "\nüíÖ Running Prettier check..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "‚ùå Prettier check failed! Run 'npm run format' to fix."
  FAILED=1
fi

# 3. TypeScript type-check
echo "\nüî∑ Running TypeScript type-check..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript type-check failed!"
  FAILED=1
fi

# 4. Ruff linter (if available)
if command -v ruff > /dev/null 2>&1; then
  echo "\nüêç Running Ruff linter..."
  ruff check .
  if [ $? -ne 0 ]; then
    echo "‚ùå Ruff linter failed!"
    FAILED=1
  fi

  echo "\nüé® Running Ruff formatter check..."
  ruff format --check .
  if [ $? -ne 0 ]; then
    echo "‚ùå Ruff formatter check failed! Run 'ruff format .' to fix."
    FAILED=1
  fi
else
  echo "\n‚ö†Ô∏è  Ruff not found, skipping Python linting (will run in CI)"
fi

# 5. MyPy type-check (if available)
if command -v mypy > /dev/null 2>&1 || python -c "import mypy" 2>/dev/null; then
  echo "\nüîç Running MyPy type-check..."
  if command -v mypy > /dev/null 2>&1; then
    mypy .
  else
    python -m mypy .
  fi
  if [ $? -ne 0 ]; then
    echo "‚ùå MyPy type-check failed!"
    FAILED=1
  fi
else
  echo "\n‚ö†Ô∏è  MyPy not found, skipping Python type checking (will run in CI)"
fi

# Check overall status
if [ $FAILED -ne 0 ]; then
  echo "\n‚ùå Pre-commit checks failed! Please fix the errors above."
  exit 1
fi

echo "\n‚úÖ All pre-commit checks passed!"
